# 技师拒绝订单功能说明

## 功能概述

技师现在可以拒绝系统自动分配给他们的维修订单。当技师拒绝订单后，系统会自动将订单重新分配给其他合适的技师。

## API 接口

### 1. 技师拒绝订单

**接口**: `POST /api/technicians/{technicianId}/reject-order/{orderId}`

**参数**:
- `technicianId`: 技师ID (路径参数)
- `orderId`: 订单ID (路径参数)  
- `reason`: 拒绝原因 (可选查询参数)

**请求示例**:
```bash
curl -X POST "http://localhost:8080/api/technicians/1/reject-order/123?reason=工作负载过重"
```

**响应示例**:
```json
{
  "message": "订单拒绝成功，系统将重新分配给其他技师"
}
```

### 2. 获取技师待处理订单

**接口**: `GET /api/technicians/{technicianId}/assigned-orders`

**参数**:
- `technicianId`: 技师ID (路径参数)

**请求示例**:
```bash
curl -X GET "http://localhost:8080/api/technicians/1/assigned-orders"
```

**响应示例**:
```json
[
  {
    "id": 123,
    "orderNumber": "ORD20241201001",
    "status": "ASSIGNED",
    "description": "发动机故障检修",
    "createdAt": "2024-12-01T10:00:00Z",
    "user": {
      "id": 1,
      "name": "张三",
      "phone": "13800138000"
    },
    "vehicle": {
      "id": 1,
      "licensePlate": "京A12345",
      "brand": "丰田",
      "model": "凯美瑞"
    }
  }
]
```

## 业务逻辑

### 拒绝订单流程

1. **验证权限**: 检查订单是否真的分配给该技师
2. **状态检查**: 只有状态为 `ASSIGNED` 的订单可以被拒绝
3. **移除分配**: 从订单的技师列表中移除当前技师
4. **重新分配**: 自动寻找其他合适的技师进行分配
5. **状态更新**: 根据重新分配结果更新订单状态

### 重新分配逻辑

- **优先级排序**: 基于技师评分、工作负载、经验等综合因素
- **技能匹配**: 确保新技师具备订单所需的技能类型
- **排除策略**: 不会将订单重新分配给刚刚拒绝的技师
- **兜底机制**: 如果没有其他可用技师，订单状态改为 `PENDING`

## 使用场景

1. **工作负载管理**: 技师工作过于繁忙时可以拒绝新订单
2. **技能不匹配**: 技师发现订单超出自己能力范围
3. **时间冲突**: 技师有其他紧急安排无法处理订单
4. **设备缺失**: 缺少处理该订单所需的工具或设备

## 注意事项

1. **只能拒绝已分配的订单**: 状态必须为 `ASSIGNED`
2. **无法重复拒绝**: 同一个订单同一个技师只能拒绝一次
3. **系统自动处理**: 拒绝后的重新分配完全由系统自动完成
4. **记录可追溯**: 所有拒绝操作都会被记录到系统日志中

## 错误处理

### 常见错误情况

- **订单不存在**: `维修订单不存在`
- **权限不足**: `此订单未分配给您，无法拒绝`
- **状态不允许**: `订单状态不允许拒绝，只有已分配状态的订单可以拒绝`
- **技师不存在**: `技师不存在`

### 系统容错

- **重新分配失败**: 订单状态会自动改为 `PENDING`，等待管理员手动分配
- **没有可用技师**: 订单状态改为 `PENDING`，并记录日志
- **网络异常**: 返回适当的HTTP状态码和错误信息

## 前端集成示例

```javascript
// 拒绝订单
async function rejectOrder(technicianId, orderId, reason) {
  try {
    const response = await fetch(
      `/api/technicians/${technicianId}/reject-order/${orderId}?reason=${encodeURIComponent(reason)}`,
      { method: 'POST' }
    );
    
    if (response.ok) {
      const result = await response.json();
      alert(result.message);
      // 刷新订单列表
      loadAssignedOrders(technicianId);
    } else {
      const error = await response.json();
      alert(`拒绝失败: ${error.message}`);
    }
  } catch (error) {
    console.error('网络错误:', error);
    alert('网络错误，请稍后重试');
  }
}

// 获取待处理订单
async function loadAssignedOrders(technicianId) {
  try {
    const response = await fetch(`/api/technicians/${technicianId}/assigned-orders`);
    const orders = await response.json();
    
    // 渲染订单列表
    renderOrderList(orders);
  } catch (error) {
    console.error('加载订单失败:', error);
  }
}
```

这个功能大大提高了技师工作的灵活性，同时保证了订单能够及时得到处理！ 